const fileListElement = document.getElementById('file-list');
const breadcrumbListElement = document.getElementById('breadcrumb-list');
const searchInput = document.getElementById('search-input');
const searchButton = document.getElementById('search-button');
const API_BASE_URL = 'https://shudong.zygame1314.site';

const FILES_API_URL = `${API_BASE_URL}/api/files`;
const DOWNLOAD_API_BASE_URL = `${API_BASE_URL}/api/download`;

let currentPrefix = '';
let currentPassword = null;
const directoryCache = {};
let isShowingSearchResults = false;

function formatBytes(bytes, decimals = 2) {
    if (bytes == null || bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    const i = Math.max(0, Math.floor(Math.log(bytes) / Math.log(k)));
    const size = parseFloat((bytes / Math.pow(k, i)).toFixed(dm));
    return (isNaN(size) ? 0 : size) + ' ' + sizes[i];
}

async function downloadFile(fileKey, password) {
    if (!password) {
        alert("Êó†Ê≥ï‰∏ãËΩΩÔºöÊú™Ëé∑ÂèñÂà∞È™åËØÅÂè£‰ª§„ÄÇËØ∑ÈáçÊñ∞È™åËØÅ„ÄÇ");
        return;
    }

    const downloadUrl = `${DOWNLOAD_API_BASE_URL}/${encodeURIComponent(fileKey)}`;
    const statusElementId = `status-${fileKey.replace(/[^a-zA-Z0-9]/g, '-')}`;
    const statusElement = document.getElementById(statusElementId);
    if (statusElement) statusElement.textContent = ' - ‰∏ãËΩΩ‰∏≠...';

    try {
        const response = await fetch(downloadUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${password}`,
            },
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileKey.includes('/') ? fileKey.substring(fileKey.lastIndexOf('/') + 1) : fileKey;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            if (statusElement) statusElement.textContent = ' - ‰∏ãËΩΩÂÆåÊàê';
        } else {
            const errorResult = await response.json().catch(() => ({ error: `HTTP error ${response.status}` }));
            console.error(`‰∏ãËΩΩ ${fileKey} Â§±Ë¥•:`, errorResult);
            alert(`‰∏ãËΩΩ ${fileKey} Â§±Ë¥•: ${errorResult.error || response.statusText}`);
             if (statusElement) statusElement.textContent = ` - ‰∏ãËΩΩÂ§±Ë¥•: ${errorResult.error || response.statusText}`;
        }
    } catch (error) {
        console.error(`‰∏ãËΩΩ ${fileKey} ËØ∑Ê±ÇÂá∫Èîô:`, error);
        alert(`‰∏ãËΩΩ ${fileKey} ËØ∑Ê±ÇÂá∫Èîô: ${error.message}`);
        if (statusElement) statusElement.textContent = ` - ‰∏ãËΩΩÈîôËØØ: ${error.message}`;
    } finally {
         setTimeout(() => {
             const finalStatusElement = document.getElementById(statusElementId);
             if (finalStatusElement) finalStatusElement.textContent = '';
         }, 5000);
    }
}


function updateBreadcrumb(prefix, isSearch = false, searchTerm = '') {
    if (!breadcrumbListElement) return;
    breadcrumbListElement.innerHTML = '';

    if (isSearch) {
         breadcrumbListElement.style.display = 'none';
         return;
    }

    breadcrumbListElement.style.display = '';

    const rootLi = document.createElement('li');
    rootLi.classList.add('breadcrumb-item');
    const rootLink = document.createElement('a');
    rootLink.href = '#';
    rootLink.textContent = 'Ê†πÁõÆÂΩï';
    rootLink.onclick = (e) => {
        e.preventDefault();
        fetchAndDisplayFiles('');
    };
    rootLi.appendChild(rootLink);
    breadcrumbListElement.appendChild(rootLi);

    if (prefix) {
        const parts = prefix.endsWith('/') ? prefix.slice(0, -1).split('/') : prefix.split('/');
        let currentPath = '';
        parts.forEach((part, index) => {
            currentPath += part + '/';
            const li = document.createElement('li');
            li.classList.add('breadcrumb-item');
            if (index === parts.length - 1) {
                li.textContent = part;
                li.setAttribute('aria-current', 'page');
            } else {
                const link = document.createElement('a');
                link.href = '#';
                link.textContent = part;
                const pathOnClick = currentPath;
                link.onclick = (e) => {
                    e.preventDefault();
                    fetchAndDisplayFiles(pathOnClick);
                };
                li.appendChild(link);
            }
            breadcrumbListElement.appendChild(li);
        });
    }
}


function renderFileList(prefix, data, isGlobalSearch = false, localSearchTerm = '') {
    fileListElement.innerHTML = '';
    const lowerLocalSearchTerm = localSearchTerm.trim().toLowerCase();

    if (isGlobalSearch) {
        isShowingSearchResults = true;
        updateBreadcrumb('', true, localSearchTerm);
        const searchInfoLi = document.createElement('li');
        searchInfoLi.textContent = `ÂÖ®Â±ÄÊêúÁ¥¢ "${localSearchTerm}" ÁöÑÁªìÊûú:`;
        searchInfoLi.classList.add('search-info');
        fileListElement.appendChild(searchInfoLi);

    } else {
        isShowingSearchResults = false;
        updateBreadcrumb(prefix);
        if (prefix !== '') {
            let lastSlashIndex = prefix.endsWith('/') ? prefix.lastIndexOf('/', prefix.length - 2) : prefix.lastIndexOf('/');
            const parentPrefix = lastSlashIndex >= 0 ? prefix.substring(0, lastSlashIndex + 1) : '';

            const backLi = document.createElement('li');
            backLi.classList.add('directory-item', 'back-button');
            const backLink = document.createElement('a');
            backLink.href = '#';
            backLink.innerHTML = '<span class="icon">‚¨ÜÔ∏è</span> ËøîÂõû‰∏ä‰∏ÄÁ∫ß';
            backLink.onclick = (e) => {
                e.preventDefault();
                if (searchInput) searchInput.value = '';
                fetchAndDisplayFiles(parentPrefix);
            };
            backLi.appendChild(backLink);
            fileListElement.appendChild(backLi);
        }
    }

    let displayedDirectories = [];
    if (!isGlobalSearch && data.directories && data.directories.length > 0) {
        let filteredDirectories = data.directories;
        if (lowerLocalSearchTerm) {
             filteredDirectories = filteredDirectories.filter(dir => dir.name.toLowerCase().includes(lowerLocalSearchTerm));
        }
        displayedDirectories = filteredDirectories;

        displayedDirectories.forEach(dir => {
            const li = document.createElement('li');
            li.classList.add('directory-item');
            const dirLink = document.createElement('a');
            dirLink.href = '#';
            dirLink.innerHTML = `<span class="icon">üìÅ</span> ${dir.name}`;
            dirLink.onclick = (e) => {
                e.preventDefault();
                if (searchInput) searchInput.value = '';
                fetchAndDisplayFiles(dir.key);
            };
            li.appendChild(dirLink);
            fileListElement.appendChild(li);
        });
    }

    let displayedFiles = [];
    if (data.files && data.files.length > 0) {
        let filteredFiles = data.files;
        if (!isGlobalSearch && lowerLocalSearchTerm) {
            filteredFiles = filteredFiles.filter(file => file.name.toLowerCase().includes(lowerLocalSearchTerm));
        }
        displayedFiles = filteredFiles;

        displayedFiles.forEach(file => {
            const isDirectoryPlaceholder = file.isDirectoryPlaceholder;
            const li = document.createElement('li');
            li.classList.add(isDirectoryPlaceholder ? 'directory-item' : 'file-item');

            let nameElement;
            const displayName = isGlobalSearch ? file.name : file.name;
            const displayIcon = isDirectoryPlaceholder ? 'üìÅ' : 'üìÑ';

            if (isDirectoryPlaceholder) {
                nameElement = document.createElement('a');
                nameElement.href = '#';
                nameElement.innerHTML = `<span class="icon">${displayIcon}</span> ${displayName}`;
                nameElement.onclick = (e) => {
                    e.preventDefault();
                    if (searchInput) searchInput.value = '';
                    fetchAndDisplayFiles(file.key);
                };
            } else {
                nameElement = document.createElement('span');
                nameElement.innerHTML = `<span class="icon">${displayIcon}</span> ${displayName}`;
            }
            nameElement.style.marginRight = '10px';


            const fileSizeSpan = document.createElement('span');
            if (!isDirectoryPlaceholder) {
                fileSizeSpan.textContent = `(${formatBytes(file.size)})`;
                fileSizeSpan.classList.add('file-size');
            }

            const downloadButton = document.createElement('button');
            if (!isDirectoryPlaceholder) {
                downloadButton.textContent = '‰∏ãËΩΩ';
                downloadButton.classList.add('download-button');
                downloadButton.onclick = () => downloadFile(file.key, currentPassword);
            }

            const statusSpan = document.createElement('span');
             if (!isDirectoryPlaceholder) {
                statusSpan.id = `status-${file.key.replace(/[^a-zA-Z0-9]/g, '-')}`;
                statusSpan.classList.add('download-status');
             }

            const infoDiv = document.createElement('div');
            infoDiv.style.display = 'flex';
            infoDiv.style.alignItems = 'center';
            infoDiv.style.flexGrow = '1';
            infoDiv.appendChild(nameElement);
            infoDiv.appendChild(fileSizeSpan);

            const actionsDiv = document.createElement('div');
            if (!isDirectoryPlaceholder) {
                 actionsDiv.appendChild(downloadButton);
                 actionsDiv.appendChild(statusSpan);
            }


            li.appendChild(infoDiv);
            li.appendChild(actionsDiv);
            fileListElement.appendChild(li);
        });
    }

    const hasDisplayedContent = displayedDirectories.length > 0 || displayedFiles.length > 0;

     if (!hasDisplayedContent) {
         const emptyLi = document.createElement('li');
         if (isGlobalSearch) {
             emptyLi.textContent = `Êâæ‰∏çÂà∞ÂåÖÂê´ "${localSearchTerm}" ÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π„ÄÇ`;
         } else if (lowerLocalSearchTerm) {
              emptyLi.textContent = `Âú®ÂΩìÂâçÁõÆÂΩï‰∏≠Êâæ‰∏çÂà∞ÂåÖÂê´ "${localSearchTerm}" ÁöÑÊñá‰ª∂ÊàñÊñá‰ª∂Â§π„ÄÇ`;
         } else {
             emptyLi.textContent = 'Ê≠§ÁõÆÂΩï‰∏∫Á©∫';
         }
         emptyLi.style.fontStyle = 'italic';
         emptyLi.style.color = '#888';

         const firstRealItem = fileListElement.querySelector('.directory-item:not(.back-button), .file-item');
         if (firstRealItem) {
             fileListElement.insertBefore(emptyLi, firstRealItem);
         } else {
             fileListElement.appendChild(emptyLi);
         }
    }
}


async function fetchAndDisplayFiles(prefix = '', searchTerm = '') {
    if (!currentPassword) {
        fileListElement.innerHTML = '<li>Êó†Ê≥ïËé∑ÂèñÊñá‰ª∂ÂàóË°®ÔºöÊú™Ëé∑ÂèñÂà∞È™åËØÅÂè£‰ª§„ÄÇËØ∑ÂÖàÈ™åËØÅ„ÄÇ</li>';
        updateBreadcrumb('');
        isShowingSearchResults = false;
        return;
    }

    const isGlobal = searchTerm.trim() !== '';
    if (!isGlobal) {
        currentPrefix = prefix;
    }


    fileListElement.innerHTML = '<li><span class="loading-indicator">Ê≠£Âú®Âä†ËΩΩÊñá‰ª∂ÂàóË°®...</span></li>';

    let url;
    if (isGlobal) {
        console.log(`ÂèëËµ∑ÂÖ®Â±ÄÊêúÁ¥¢: "${searchTerm}"`);
        url = `${FILES_API_URL}?search=${encodeURIComponent(searchTerm.trim())}`;
    } else {
        console.log(`Âä†ËΩΩÁõÆÂΩï: "${prefix || 'Ê†πÁõÆÂΩï'}"`);
        url = `${FILES_API_URL}?prefix=${encodeURIComponent(prefix)}`;
        const localSearchTerm = searchInput ? searchInput.value.trim() : '';
        if (!localSearchTerm && directoryCache[prefix]) {
            console.log(`‰ªéÁºìÂ≠òÂä†ËΩΩ: ${prefix || 'Ê†πÁõÆÂΩï'}`);
            renderFileList(prefix, directoryCache[prefix], false, '');
            isShowingSearchResults = false;
            updateBreadcrumb(prefix);
            return;
        }
    }

    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${currentPassword}`,
            },
        });

        let result;
        try {
            result = await response.json();
        } catch (jsonError) {
            console.error("JSON Ëß£ÊûêÈîôËØØ:", jsonError);
            result = { success: false, error: `Êó†Ê≥ïËß£ÊûêÂìçÂ∫î: ${response.statusText}` };
        }

        if (response.ok && result.success) {
            const receivedData = {
                files: result.files || [],
                directories: result.directories || [],
            };
             if (result.files) {
                 receivedData.files.forEach((file, index) => {
                     if (result.files[index] && result.files[index].isDirectoryPlaceholder !== undefined) {
                         file.isDirectoryPlaceholder = result.files[index].isDirectoryPlaceholder;
                     } else {
                         file.isDirectoryPlaceholder = false;
                     }
                 });
             }


            if (!isGlobal) {
                directoryCache[prefix] = { files: receivedData.files, directories: receivedData.directories };
                console.log(`ÁºìÂ≠òÂ∑≤Êõ¥Êñ∞: ${prefix || 'Ê†πÁõÆÂΩï'}`);
            }
            const currentLocalSearch = searchInput ? searchInput.value.trim() : '';
            renderFileList(isGlobal ? '' : prefix, receivedData, isGlobal, isGlobal ? searchTerm.trim() : currentLocalSearch);
        } else {
            const errorMessage = result?.error || `HTTP ÈîôËØØ ${response.status}`;
            console.error("Ëé∑ÂèñÊñá‰ª∂ÂàóË°®Â§±Ë¥•:", errorMessage, result);
            fileListElement.innerHTML = `<li>Ëé∑ÂèñÊñá‰ª∂ÂàóË°®Â§±Ë¥•: ${errorMessage}</li>`;
            isShowingSearchResults = isGlobal;
            updateBreadcrumb(isGlobal ? '' : prefix, isGlobal, searchTerm.trim());
        }
    } catch (error) {
        console.error("Ëé∑ÂèñÊñá‰ª∂ÂàóË°®ËØ∑Ê±ÇÂá∫Èîô:", error);
        fileListElement.innerHTML = `<li>Ëé∑ÂèñÊñá‰ª∂ÂàóË°®ËØ∑Ê±ÇÂá∫Èîô: ${error.message}</li>`;
        isShowingSearchResults = isGlobal;
        updateBreadcrumb(isGlobal ? '' : prefix, isGlobal, searchTerm.trim());
    }
}

document.addEventListener('authSuccess', (event) => {
    currentPassword = event.detail?.password;
    if (currentPassword) {
        console.log("È™åËØÅÊàêÂäüÔºåÂºÄÂßãÂä†ËΩΩÊ†πÁõÆÂΩïÊñá‰ª∂ÂàóË°®...");
        fetchAndDisplayFiles('');
    } else {
        console.error("È™åËØÅÊàêÂäü‰∫ã‰ª∂Êú™Êèê‰æõÂØÜÁ†ÅÔºÅ");
        fileListElement.innerHTML = '<li>È™åËØÅÂá∫ÈîôÔºåÊó†Ê≥ïÂä†ËΩΩÊñá‰ª∂„ÄÇ</li>';
        updateBreadcrumb('');
    }
});

document.addEventListener('DOMContentLoaded', () => {
    fileListElement.innerHTML = '<li>ËØ∑ÂÖàÂÆåÊàêÈ™åËØÅ‰ª•Êü•ÁúãÊñá‰ª∂„ÄÇ</li>';
    updateBreadcrumb('');
    currentPassword = null;
    currentPrefix = '';
});

if (searchButton && searchInput) {
    const performSearch = () => {
        const searchTerm = searchInput.value.trim();
        if (searchTerm) {
            fetchAndDisplayFiles('', searchTerm);
        } else {
            fetchAndDisplayFiles(currentPrefix, '');
        }
    };

    searchButton.addEventListener('click', performSearch);

    searchInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            performSearch();
        }
    });

    searchInput.addEventListener('input', () => {
        if (searchInput.value.trim() === '') {
             fetchAndDisplayFiles(currentPrefix, '');
        }
    });
}